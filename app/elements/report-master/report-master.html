<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="..\..\bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="..\..\bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="..\..\bower_components/paper-progress/paper-progress.html">

<dom-module id="report-master">
  <template>
<style>
  :host .content-container>::content #reportalPage{
    height:100%
  }
  :host .content-container>::content #wait_c .underlay{
    display:none !important;
  }
  :host .content-container>::content #wait_c{
    left:0 !important;
    top:0 !important;
    position:relative !important;
    width:100%;
    margin: 0 !important;
    visibility:hidden;
    padding:0 !important;
    @apply(--report-master-loading-progress);
  }
  :host .content-container>::content #wait_c paper-progress{
    width:100%;
  }
  :host .content-container>::content #wait_c #primaryProgress{
    background-color: var(--report-master-loading-progress-color, --dark-primary-color);
  }
  paper-scroll-header-panel[drawer]:not([narrow]){border-right:1px solid #ededed}
</style>
    <paper-drawer-panel id="paperDrawerPanel">
      <!-- Drawer Scroll Header Panel -->
      <paper-scroll-header-panel drawer fixed>
        <!-- Drawer Content-->
        <content select="#reportalSidebar"></content>
      </paper-scroll-header-panel>

      <!-- Main Area -->
      <div main class="content-container">
        <content select="#reportalPage"></content>
      </div>
    </paper-drawer-panel>

    <!-- Uncomment next block to enable Service Worker support (1/2) -->
    <!--
    <paper-toast id="caching-complete"
                 duration="6000"
                 text="Caching complete! This app will work offline.">
    </paper-toast>

    <platinum-sw-register auto-register
                          clients-claim
                          skip-waiting
                          on-service-worker-installed="displayInstalledToast">
      <platinum-sw-cache default-cache-strategy="networkFirst"
                         precache-file="precache.json">
      </platinum-sw-cache>
    </platinum-sw-register>
    -->

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'report-master',
        listeners:{
          'paper-header-transform':'_condenseHeader',
          'tap':'_panelToggle'
        },
        properties:{
          replaceLoadingAnimation:{
            type:Boolean,
            value:false
          }
        },
        ready:function(){
          if(this.replaceLoadingAnimation){this._replaceLoadingAnimation();}
        },

        _panelToggle:function(e){
          if(e.target.hasAttribute('paper-drawer-toggle') || e.target.parentNode.hasAttribute('paper-drawer-toggle')){
            this.$.paperDrawerPanel.openDrawer();
          }
        },

        _replaceLoadingAnimation: function () {
          var that=this;
          var progress = document.createElement('paper-progress');
          Polymer.dom(progress).setAttribute('indeterminate','');
            this.async(function(){
              try{
                this._poll(
                function(){
                  return document.querySelector('#wait_c');
                },
                function(){
                  var container = document.querySelector('#wait_c');
                  if(container){
                    container.setAttribute('style','');
                    container.innerHTML='';
                    container.appendChild(progress);
                    var toolbar=document.querySelector('#reportalPage #headerContainer');
                    if(toolbar){toolbar.appendChild(container);}
                  }
                  //Polymer.updateStyles();
                },
                function(){console.log('failed to find & restyle loading progress for <report-master>')},
                5000, //5 seconds total
                1000 //check every second
              );
              } catch(e){
                alert( e.name + ":" + e.message + "\n" + e.stack); // (3) <--
              }


            },3000);
        },
        _poll:function(fn, callback, errback, timeout, interval) {
          var endTime = Number(new Date()) + (timeout || 2000);
          interval = interval || 100;

          (function p() {
            // If the condition is met, we're done!
            if(fn()) {
              callback();
            }
            // If the condition isn't met but the timeout hasn't elapsed, go again
            else if (Number(new Date()) < endTime) {
              setTimeout(p, interval);
            }
            // Didn't match and too much time, reject!
            else {
              errback(new Error('timed out for ' + fn + ': ' + arguments));
            }
          })();
        },
        _condenseHeader:function(e){
          this.async(function() {
            var appName = Polymer.dom(e.target).querySelector('.app-name');
            var middleContainer = Polymer.dom(e.target).querySelector('.middle-container');
            var bottomContainer = Polymer.dom(e.target).querySelector('.bottom-container');
            var detail = e.detail;
            var heightDiff = detail.height - detail.condensedHeight;
            var yRatio = Math.min(1, detail.y / heightDiff);
            var maxMiddleScale = 0.50;  // appName max size when condensed. The smaller the number the smaller the condensed size.
            var scaleMiddle = Math.max(maxMiddleScale, (heightDiff - detail.y) / (heightDiff / (1 - maxMiddleScale)) + maxMiddleScale);
            var scaleBottom = 1 - yRatio;

            // Move/translate middleContainer
            this.transform('translate3d(0,' + yRatio * 100 + '%,0)', middleContainer);

            // Scale bottomContainer and bottom sub title to nothing and back
            this.transform('scale(' + scaleBottom + ') translateZ(0)', bottomContainer);

            // Scale middleContainer appName
            this.transform('scale(' + scaleMiddle + ') translateZ(0)', appName);
          });
        }
      });

 })();
  </script>
</dom-module>



