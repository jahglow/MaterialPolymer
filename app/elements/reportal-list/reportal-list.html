<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="..\..\bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="..\..\bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="..\..\bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="..\..\bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="..\..\bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="..\..\bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="..\..\bower_components/iron-list/iron-list.html">
<link rel="import" href="..\..\bower_components/iron-icon/iron-icon.html">
<link rel="import" href="..\..\bower_components/iron-icons/iron-icons.html">

<dom-module id="reportal-list">
  <template>
    <style>
      :host {
        display: inline-block;
        @apply(--reportal-list);
      }
      :host paper-checkbox{
        display: block;
        padding: 8px 8px;
        @apply(--reportal-list-checkbox);
      }
      :host paper-radio-group{
        display: block;
        @apply(--reportal-list-radio-group);
      }
      :host paper-radio-group paper-radio-button{
        display: block;
        padding: 8px 8px;
        @apply(--reportal-list-radio-button);
      }
      :host #listWrapper{
       display:none;
      }
      :host #wrapperLabel{
        margin: 8px 8px 0 8px;
        display: none;
        position: relative;
        font-weight: 500;
        color: var(--secondary-text-color);
        font-size: 13px;
        line-height: 24px;
        text-transform: uppercase;
        @apply(--reportal-sidebar-section-title);
        @apply(--reportal-wrap-list-label);
      }

      /* multiselect list*/
      :host div.selected{
        background-color:var(--light-primary-color);
        @apply(--reportal-list-multiselect-selected);
      }
      :host iron-list .item{
        line-height: 36px;
        vertical-align: middle;
        padding: 0 16px ;
        @apply(--reportal-list-multiselect-item);
      }
      :host iron-list{
        height:200px;
        margin: 8px;
        border-bottom:1px solid;
        border-bottom-color:  var(--dark-primary-color);
        @apply(--reportal-list-multiselect);
      }
      :host paper-listbox paper-icon-item{--paper-item-icon-width:0px}
      :host paper-listbox[multi] paper-icon-item iron-icon{visibility:hidden}
      :host paper-listbox[multi] paper-icon-item{--paper-item-icon-width:56px}

      :host paper-listbox[multi] paper-icon-item[selected] iron-icon{visibility:visible}
      :host paper-dropdown-menu{
        margin:8px;
        width: calc(100% - 16px);
        display:block;
        @apply(--reportal-list-dropdown);
      }
      :host paper-checkbox:first-child, :host paper-radio-group:first-child{padding-top: 32px}
    </style>
    <span id="wrapperLabel">
      <content select=".wrapper-label"></content>
    </span>
    <span id="listWrapper">
      <content></content>
    </span>


    <paper-dropdown-menu hidden$="[[!isDropdown]]" label="[[label]]" id="dd" vertical-align$="{{verticalAlign}}" horizontal-align$="{{horizontalAlign}}">
      <paper-listbox class="dropdown-content" attr-for-selected="value" selected-attribute="selected" id="ddListbox">
        <template is="dom-repeat" items="[[ddData]]" as="item">
          <paper-icon-item value$="[[item.value]]"><iron-icon icon="check" item-icon></iron-icon>[[item.textContent]]</paper-icon-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>

    <!--<iron-list id="dropDownList" hidden$="{{!multi}}" items="{{ddData}}" selection-enabled multi-selection selected-items="{{selectedItems}}" as="item">
        <template>
            <div on-tap="_reflectToList" tabindex="0" aria-label$="[[_getAriaLabel(item, selected)]]" class$="[[_computedClass(item, selected)]]">{{item.textContent}}</div>
        </template>
       </iron-list>-->
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'reportal-list',
        listeners:{
          'change':'_reflectToCheckbox',
          'iron-select':'_reflectToOriginal',
          'iron-deselect':'_reflectToOriginal'
        },
        properties: {
          listType: String,
          multi: {
            type: Boolean,
            value: false,
            notify:true
          },
          label:{
            type:String
          },
          isDropdown:{
            type:Boolean,
            value:false,
            notify:true
          },
          ddData:{
            type:Array,
            notify:true
          },
          selectedItems: {
            type: Object,
            value:{},
            notify:true
          },
          forceCustomLabel:{
            type: Boolean,
            value:false
          },
          verticalAlign:{
            type:String,
            value:'top'
          },
          keepOpen:{
            type:Boolean,
            value:false
          },
          horizontalAlign:{
            type:String,
            value:'right'
          }
        },
        ready:function(){
          var el;
          //this.async(
          //function(){
          /*this.$.dd._selectedItemChanged = function(selectedItem) {
            var paperListbox = this.querySelector('paper-listbox');
            var value = '';
            this.async(function(){if (!selectedItem) {
              if(paperListbox && paperListbox.selectedItems && paperListbox.selectedItems.length>0){
                var labels = [];
                for(var i=0;i<paperListbox.selectedItems;i++){
                  labels.push(paperListbox.selectedItems[i].textContent.trim())
                }
                value = labels.join(', ');
              } else {value = '';}

            } else {
              if(paperListbox && paperListbox.selectedItems && paperListbox.selectedItems.length>0){
                console.log(paperListbox.selectedItems);
                var labels = [];
                for(var i=0;i<paperListbox.selectedItems;i++){
                  console.log(paperListbox.selectedItems[i]);
                  labels.push(paperListbox.selectedItems[i].textContent.trim())
                }
                value = labels.join(', ');
              } else {
                value = selectedItem.label || selectedItem.textContent.trim();
              }
            }

            this._setValue(value);
            this._setSelectedItemLabel(value);});
          }*/

          var inlineLabel = this.$.wrapperLabel.querySelector('.wrapper-label');
          if(inlineLabel && !this.label){this.label=inlineLabel.textContent;}
          if(Polymer.dom(this).querySelector('input')){
            if(this.label){this._computeLabel(this.label);}
            el = Polymer.dom(this).querySelector('input');
            this.listType = el.type;
            this._computeCheckboxRadio();
          }
          else if(Polymer.dom(this).querySelector('select')){
            this.ddData=Polymer.dom(this).querySelectorAll('option');
            var select = Polymer.dom(this).querySelector('select');
            if(select.multiple){
              Polymer.dom(this.$.ddListbox).setAttribute('multi','');
              this.multi = true;
            }
            if(this.label || this.forceCustomLabel){this._computeLabel(this.label);}
            if(this.forceCustomLabel){
              this.$.dd.noLabelFloat = true;
            }
            this.isDropdown=true;
            this.listType = 'dropdown';
          }
          //}
          //);
        },
        attached:function(){
          if(this.isDropdown){
            var selected=Polymer.dom(this).querySelectorAll('option').filter(function(item){return item.selected;});
            if(!this.multi){
              Polymer.dom(this.$.ddListbox).setAttribute('selected',selected[0].value);
            } else {
              var s=[];
              for(var i=0;i<selected.length;i++){
                s.push(selected[i].value);
              }
              Polymer.dom(this.$.ddListbox).setAttribute('selected-values', JSON.stringify(s));
            }
          }
        },

        _computeList:function(){
          this.ddData=Polymer.dom(this).querySelectorAll('option'); //option[i].value (String), option[i].textContent (String), option[i].selected (Bool)
        },
        _computeCheckboxRadio:function(){
          var rg;
          if(this.listType === 'radio'){
            rg=document.createElement('paper-radio-group');
            Polymer.dom(rg).setAttribute('attr-for-selected','target');
          }
          var cbr = Polymer.dom(this).querySelectorAll('input[type="'+this.listType+'"]');
          if(cbr.length>0){
            var c;
            for(var i=0;i<cbr.length;i++){
              switch(this.listType){
                case 'checkbox': c=document.createElement('paper-checkbox');break;
                case 'radio': c=document.createElement('paper-radio-button');break;
              }
              Polymer.dom(c).setAttribute('target',cbr[i].id);
              if(cbr[i].checked){
                Polymer.dom(c).setAttribute('checked','');
                if(rg){
                  Polymer.dom(rg).setAttribute('selected',cbr[i].id);
                }
              }
              Polymer.dom(c).textContent = (Polymer.dom(this).querySelector('label[for="'+cbr[i].id+'"]')).textContent;
              rg ? Polymer.dom(rg).appendChild(c) : Polymer.dom(this.root).appendChild(c);
            }
            if(rg){Polymer.dom(this.root).appendChild(rg);}
          }
        },
        _reflectToOriginal:function(e){
          switch(this.listType){
            case 'checkbox': this._reflectToCheckbox(e);break;
            case 'radio': this._reflectToRadio(e);break;
            case 'dropdown': this._reflectToDropdown(e);break;
          }
        },
        /*_reflectToList:function(e){
          var hostInput = Polymer.dom(this).querySelector('select option[value="'+e.model.item.value+'"]');
          if(!hostInput.selected){
            hostInput.selected = true;
            hostInput.setAttribute('selected','selected');
          } else {
            hostInput.selected = false;
            hostInput.removeAttribute('selected');
          }
        },*/
        _reflectToDropdown:function(e){
          if(this.multi && this.keepOpen){
            this.$.dd.open();
          }
          var el = this.querySelector('select option[value="'+e.detail.item.value+'"]');
          if(e.detail.item.hasAttribute('selected')){
            el.selected=true;
          } else {
            el.selected=false;
          }
        },
        _reflectToCheckbox:function(e){
          if(this.listType === 'checkbox'){
            var hostInput = Polymer.dom(this).querySelector('input[id="'+e.target.attributes.target.value+'"]');
            hostInput.checked ? hostInput.checked = false : hostInput.checked = true;
          }
        },
        _reflectToRadio:function(e){
          this.$$('paper-radio-group').setAttribute('selected',e.detail.item.attributes.getNamedItem('target').value);
          var hostInput = this.querySelector('input[id="'+e.detail.item.attributes.getNamedItem('target').value+'"]');
          hostInput.checked = true;
        },

        _getAriaLabel: function(item, selected) {
          return selected ? 'Deselect ' + item.textContent : 'Select ' + item.textContent;
        },
        _computedClass: function(item,selected) {
          if(item.attributes.selected && !selected){
            this.$.dropDownList.selectItem(item);
          }
          var classes = 'item';
          if (selected ) {
            classes += ' selected';
          }
          return classes;
        },
        _computeLabel:function(labelText){
          if(labelText && labelText.length>0){
            this.$.wrapperLabel.textContent = labelText;
          }
          this.$.wrapperLabel.setAttribute('style','display:block');
        }

      });
    })();
  </script>
</dom-module>
