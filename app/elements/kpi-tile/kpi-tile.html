<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="..\..\bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="..\..\bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="..\..\bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="..\..\bower_components/paper-styles/paper-styles.html">
<link rel="import" href="..\..\bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="..\..\bower_components/neon-animation/neon-animations.html">
<link rel="import" href="..\kpi-tile-behavior/kpi-tile-behavior.html">


<dom-module id="reveal-content">
  <style>
    :host {
      display: block;
      overflow: hidden;

    }
    #placeholder {
      opacity: 0;
      background-color: grey;
    }
    :host ::content .tile-content {
      padding: 16px;
      padding-top:0;
      position:relative;
    @apply(--kpi-tile-reveal);
    }

  </style>
  <template>

    <div id="placeholder" class="fit"></div>

    <div id="container">
      <content select="div"></content>
    </div>

  </template>
</dom-module>
<dom-module id="kpi-content">
  <style>
    :host {
      display: block;
      overflow: hidden;
      @apply(--layout-vertical);
    }
    #placeholder {
      opacity: 0;
      background-color: grey;
    }
    #container>::content>.tile-content {
      padding: 16px;
      padding-top:0;
      position:relative;
      @apply(--layout-self-stretch);
      height: 100%;
      @apply(--kpi-tile-content);
    }
    #container{
      @apply(--layout-self-stretch);
      height: 100%;
      @apply(--layout-vertical);
    }
    :host ::content .tile-actions {
      border-top: 1px solid #e8e8e8;
      padding: 5px 16px;
      position:relative;
    @apply(--kpi-tile-actions);
    }
    :host ::content #info{display:none}
  </style>
  <template>

    <div id="placeholder" class="fit"></div>

    <div id="container">
      <content select="div"></content>
    </div>

  </template>
</dom-module>

<script>
  (function() {
    Polymer({
      is: 'kpi-content',
      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior
      ],
      properties: {
        animationConfig: {
          value: function() {
            return {
              'entry': [{
                name: 'reverse-ripple-animation',
                id: 'reverse-ripple',
                toPage: this
              }],
              'exit': [{
                name: 'fade-out-animation',
                node: this.$.container,
                timing: {
                  delay: 150,
                  duration: 0
                }
              }, {
                name: 'ripple-animation',
                id: 'ripple',
                fromPage: this
              }]
            };
          }
        }
      }
    });
  })();
  (function() {
    Polymer({
      is: 'reveal-content',
      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior
      ],
      properties: {
        animationConfig: {
          value: function() {
            return {
              'entry': [{
                name: 'ripple-animation',
                id: 'ripple',
                toPage: this
              }, {
                name: 'fade-out-animation',
                node: this.$.placeholder,
                timing: {
                  delay: 250
                }
              }, {
                name: 'fade-in-animation',
                node: this.$.container,
                timing: {
                  delay: 50
                }
              }],
              'exit': [{
                name: 'opaque-animation',
                node: this.$.placeholder
              }, {
                name: 'fade-out-animation',
                node: this.$.container,
                timing: {
                  duration: 0
                }
              }, {
                name: 'reverse-ripple-animation',
                id: 'reverse-ripple',
                fromPage: this
              }]
            };
          }
        },
        sharedElements: {
          value: function() {
            return {
              'ripple': this.$.placeholder,
              'reverse-ripple': this.$.placeholder
            };
          }
        }
      }
    });
  })();
</script>

<dom-module id="kpi-tile">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        box-sizing: border-box;

        background: #fff;
        border-radius: 2px;
        @apply(--layout-flex); @apply(--layout-self-start);
        min-width:200px;
      @apply(--kpi-tile);

      }
      :host>reveal-content{display:none}
      :host.valign-middle #tile>::content .tile-content{
        @apply(--layout-horizontal);
        @apply(--layout-self-stretch);
        @apply(--layout-center);
      }
      :host.valign-middle kpi-content{
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        height: 100%;
      }
      neon-animated-pages {
      height:100%
      }

      paper-material {
        border-radius: inherit;
      @apply(--layout-fit);
      }

      /* IE 10 support for HTML5 hidden attr */
      [hidden] {
        display: none !important;
      }

      .header {
        position: relative;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      @apply(--kpi-tile-header);
      }
      .header iron-icon {
        padding:16px;
        --iron-icon-height:20px;
        --iron-icon-width:20px;
        color:inherit
      }

      .header img {
        width: 100%;
        pointer-events: none;
      }
      .image .header{
        padding-top: 56px;
        background:linear-gradient(to top, rgba(0,0,0,0.4) 0%,rgba(0,0,0,0.3) 20%, rgba(0,0,0,0.2) 40%, rgba(0,0,0,0.1) 65%, rgba(0,0,0,0));

      }

      .header .title-text {
        padding: 16px;
        font-size: 20px;
        font-weight: 500;
        color: var(--kpi-tile-header-color, #000);
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;

        @apply(--layout-flex);
        @apply(--kpi-tile-header-text);
      }

      .image>.header .title-text, .image>.header iron-icon {
        color:white !important;
        @apply(--kpi-tile-header-image-text);
      }
      .header .title-text.pl0{
        padding-left:0 !important;
      }
      .header .title-text.pr0{
        padding-right:0 !important;
      }
      .header .title-text.pr0.pl0{
        text-align: center;
      }
      .button {cursor:pointer}
      .button iron-icon{
        padding:12px;
        --iron-icon-height:24px;
        --iron-icon-width:24px;}


      #revealContent{
        @apply(--kpi-tile-reveal);
      }
      .image{
        background-size: cover;
        -moz-background-size: cover;  /* Firefox 3.6 */
        background-position: 50% 50%;  /* Internet Explorer 7/8 */
        padding-top: calc(56.25% - 56px * 2);
        margin-bottom: 16px;
        border-top-left-radius: 2px;
        border-top-right-radius: 2px;
        @apply(--kpi-tile-header-image);
      }



    </style>
    <paper-material animated$="[[animatedShadow]]" elevation="[[elevation]]"></paper-material>
    <neon-animated-pages id="revealPage" hidden$="[[!info]]"></neon-animated-pages>
      <kpi-content id="tile" >
        <div class="header-wrapper">
        <div class="header">
          <iron-icon hidden$="[[!icon]]" icon="[[icon]]"></iron-icon>
          <div hidden$="[[!heading]]" id="tileHeading" >[[heading]]</div>
          <div hidden$="[[!info]]" class="button" on-click="_displayInfo">
            <iron-icon  icon="info-outline" id="infoIcon"></iron-icon>
            <paper-tooltip for="infoIcon" position="bottom" offset="0">[[tooltip]]</paper-tooltip>
          </div>
        </div></div>
        <content id="helloWorld"></content>
      </kpi-content>

      <reveal-content id="rc">
        <div class="header">
          <div class="button" on-click="_hideInfo">
            <iron-icon icon="arrow-back" id="backIcon"></iron-icon>
            <paper-tooltip for="backIcon" position="bottom" offset="0">Return</paper-tooltip>
          </div>
          <div hidden$="[[!heading]]" id="revealHeading" class="title-text">[[heading]]</div>
        </div>
        <div class="tile-content" id="revealContent"></div>
      </reveal-content>


  </template>
</dom-module>
  <script>
  (function() {
    'use strict';

    new Polymer({
      is: 'kpi-tile',
      behaviors: [
        Polymer.KpiTileBehavior
      ],
      ready:function(){
        this._computeHeadingClass();
      },
      attached:function(){
        this._computeInfo();
      },
      _wrapNeonPages:function(){
        //a hack to automatically compute height for the tile if not set explicitly
        this._calculateHeight();
        if(this.$.revealPage.children.length===0){
          var tileInnerContent= this.$.helloWorld;
          Polymer.dom(this.$.revealPage).appendChild(this.$.tile);
          Polymer.dom(this.$.revealPage).appendChild(this.$.rc);
          Polymer.dom(this.$.tile).appendChild(tileInnerContent);
          this.$.revealPage.selected=0;
        }
      },
      _calculateHeight:function(){
        if(!this.style.height){this.style.height=window.getComputedStyle(this.$.tile).getPropertyValue('height');}
      },
      _displayInfo : function(event) {
        this.$.tile.sharedElements = {
          'ripple': event.target,
          'reverse-ripple': event.target
        };
        this.$.revealPage.selected = 1;
      },
      _hideInfo : function() {
        this.$.revealPage.selected = 0;
      },
      //TODO: divide reveal header and tile header classes.
      _computeHeadingClass: function() {
        var cls = ['title-text'];
        //remove extra paddings on title and justify if both icons
        if (this.icon && (this.info || Polymer.dom(this).querySelector('#info'))){cls.push('center-justified'); cls.push('pl0');cls.push('pr0');}
        else if (this.icon) {cls.push('pl0');}
        else if (this.info || Polymer.dom(this).querySelector('#info')) {cls.push('pr0');}
        if(this.image){
          this.$$('.header-wrapper').classList.add('image');
          this.$$('.image').style.background='url('+this.image+')';
          }
        if(this.$.tileHeading && this.$.tileHeading.classList && !this.$.tileHeading.classList.contains('title-text')){
          for(var i=0;i<cls.length;i++){this.$.tileHeading.classList.add(cls[i]);}
        }
        if(this.$.revealHeading && this.$.revealHeading.classList && !this.$.revealHeading.classList.contains('title-text')){
          Polymer.dom(this.$.revealHeading).setAttribute('class', cls.join(' '));
        }

      },
      _computeInfo: function() {
        if(!this.info){
          var supposedInfo = Polymer.dom(this).querySelector('#info');
          if(supposedInfo){
            this.info = supposedInfo.innerHTML;
            Polymer.dom(this).removeChild(supposedInfo);
          }
        }
        if(this.info && this.info.length>0){ // passed as attribute
          this.$.revealContent.innerHTML = this.info;
          this._wrapNeonPages();
        }
      }

    });
  })();
  </script>


