<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="..\..\bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="..\..\bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="..\..\bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="..\..\bower_components/paper-styles/paper-styles.html">
<link rel="import" href="..\neon-animated-pages-autosize/neon-animated-pages-autosize.html">
<link rel="import" href="..\..\bower_components/neon-animation/neon-animations.html">
<link rel="import" href="..\kpi-tile-behavior/kpi-tile-behavior.html">
<link rel="import" href="..\..\bower_components/iron-resizable-behavior/iron-resizable-behavior.html">



<dom-module id="reveal-content">
  <style>
    :host {
      display: block;
      overflow: hidden;
      height:inherit;
    }
    #placeholder {
      opacity: 0;
      background-color: grey;
    }
    :host ::content .tile-content {
      padding: 16px;
      padding-top:0;
      position:relative;
      overflow:auto;
      @apply(--kpi-tile-reveal);
    }
    #container{
      @apply(--layout-vertical);
      @apply(--layout-fit);

    }

  </style>
  <template>

    <div id="placeholder" class="fit"></div>

    <div id="container">
      <content select="div"></content>
    </div>

  </template>
</dom-module>
<dom-module id="kpi-content">
  <style>
    :host {
      display: block;
      overflow: hidden;
      height:inherit;
      @apply(--layout-vertical);
    }
    #placeholder {
      opacity: 0;
      background-color: grey;
    }
    #container>::content>.tile-content {
      position:relative;
      @apply(--layout-self-stretch);
      height: 100%;
      @apply(--kpi-tile-content);
    }
    #container{
      @apply(--layout-self-stretch);
     height:100%;
      @apply(--layout-vertical);
    }
    :host ::content .tile-actions {
      border-top: 1px solid #e8e8e8;
      padding: 5px 16px;
      position:relative;
      @apply(--kpi-tile-actions);
    }
    :host ::content #info{display:none}
  </style>
  <template>

    <div id="placeholder" class="fit"></div>

    <div id="container">
      <content select="div"></content>
    </div>

  </template>
</dom-module>

<script>
  (function() {
    Polymer({
      is: 'kpi-content',
      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior
      ],
      properties: {
        animationConfig: {
          value: function() {
            return {
              'entry': [{
                name: 'reverse-ripple-animation',
                id: 'reverse-ripple',
                toPage: this
              }],
              'exit': [{
                name: 'fade-out-animation',
                node: this.$.container,
                timing: {
                  delay: 150,
                  duration: 0
                }
              }, {
                name: 'ripple-animation',
                id: 'ripple',
                fromPage: this
              }]
            };
          }
        }
      }
    });
  })();
  (function() {
    Polymer({
      is: 'reveal-content',
      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior
      ],
      properties: {
        animationConfig: {
          value: function() {
            return {
              'entry': [{
                name: 'ripple-animation',
                id: 'ripple',
                toPage: this
              }, {
                name: 'fade-out-animation',
                node: this.$.placeholder,
                timing: {
                  delay: 250
                }
              }, {
                name: 'fade-in-animation',
                node: this.$.container,
                timing: {
                  delay: 50
                }
              }],
              'exit': [{
                name: 'opaque-animation',
                node: this.$.placeholder
              }, {
                name: 'fade-out-animation',
                node: this.$.container,
                timing: {
                  duration: 0
                }
              }, {
                name: 'reverse-ripple-animation',
                id: 'reverse-ripple',
                fromPage: this
              }]
            };
          }
        },
        sharedElements: {
          value: function() {
            return {
              'ripple': this.$.placeholder,
              'reverse-ripple': this.$.placeholder
            };
          }
        }
      }
    });
  })();
</script>

<dom-module id="kpi-tile">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        box-sizing: border-box;
        will-change:height;
        transition: height 0.25s ease-in;
        background: #fff;
        border-radius: 2px;
        min-width:200px;
        @apply(--kpi-tile);

      }
      :host>reveal-content{display:none}
      :host.valign #tile>::content .tile-content{
        @apply(--layout-horizontal);
        @apply(--layout-self-stretch);
        @apply(--layout-center);
        @apply(--layout-flex);
      }
      :host.flex #tile>::content .tile-content{
        @apply(--layout-horizontal);
        @apply(--layout-self-stretch);
        @apply(--layout-center);
      }
      :host.valign,
      /*:host.valign>#revealPage,*/
      :host.valign #tile,:host.valign ::content #container{
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }


 /*     :host.valign-middle kpi-content{
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        height: 100%;
      }*/
      neon-animated-pages-autosize {
        height:100%;
      }

      paper-material {
        border-radius: inherit;
        @apply(--layout-fit);
      }

      /* IE 10 support for HTML5 hidden attr */
      [hidden] {
        display: none !important;
      }

      .header {
        position: relative;
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--kpi-tile-header);
      }
      .header iron-icon {
        padding:16px 24px;
        --iron-icon-height:20px;
        --iron-icon-width:20px;
        color:inherit
      }

      .header img {
        width: 100%;
        pointer-events: none;
      }
      .image .header{
        padding-top: calc(56.25% - 56px);
        background: linear-gradient(to top, rgba(0,0,0,0.4) 0%,rgba(0,0,0,0.3) 8%, rgba(0,0,0,0.2) 15%, rgba(0,0,0,0.1) 25%, rgba(0,0,0,0) 60%);
      }

      .header .title-text {
        padding: 16px 24px;
        font-size: 20px;
        font-weight: 500;
        color: var(--kpi-tile-header-color, #000);
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;

        @apply(--layout-flex);
        @apply(--kpi-tile-header-text);
      }

      .image>.header .title-text, .image>.header iron-icon {
        color:white !important;
        @apply(--kpi-tile-header-image-text);
      }
      .header .title-text.pl0{
        padding-left:0 !important;
      }
      .header .title-text.pr0{
        padding-right:0 !important;
      }
      .header .title-text.pr0.pl0{
        text-align: center;
      }
      .button {cursor:pointer}
      .button iron-icon{
        padding:12px;
        --iron-icon-height:24px;
        --iron-icon-width:24px;}


      #revealContent{
        @apply(--kpi-tile-reveal);
      }
      .image{
        background-size: cover;
        -moz-background-size: cover;  /* Firefox 3.6 */
        background-position: 50% 50%;  /* Internet Explorer 7/8 */
        margin-bottom: 16px;
        border-top-left-radius: 2px;
        border-top-right-radius: 2px;
        @apply(--kpi-tile-header-image);
      }

      /* specific styles for reportal-aggregated-table */
      :host #tile>::content .tile-content reportal-aggregated-table .vaadin-grid-sidebar.vaadin-grid{
        top: -54px;
      }

      :host.hasInfo #tile>::content .tile-content reportal-aggregated-table .vaadin-grid-sidebar.vaadin-grid{
        right: 40px;
      }

    </style>
    <paper-material animated$="[[animatedShadow]]" elevation="[[elevation]]"></paper-material>
    <neon-animated-pages-autosize selected="0" preserve-initial-height$="[[preserveInitialHeight]]" id="revealPage">
      <kpi-content id="tile" >
        <div class="header-wrapper">
          <div class="header">
            <iron-icon hidden$="[[!icon]]" icon="[[icon]]"></iron-icon>
            <div hidden$="[[!heading]]" id="tileHeading" >[[heading]]</div>
            <div hidden$="[[!info]]" class="button" on-click="_displayInfo">
              <iron-icon  icon="info-outline" id="infoIcon"></iron-icon>
              <paper-tooltip for="infoIcon" position="bottom" offset="0">[[tooltip]]</paper-tooltip>
            </div>
          </div></div>
        <content id="helloWorld"></content>
      </kpi-content>

      <reveal-content id="rc" hidden$="[[!info]]">
        <div class="header">
          <div class="button" on-click="_hideInfo">
            <iron-icon icon="arrow-back" id="backIcon"></iron-icon>
            <paper-tooltip for="backIcon" position="bottom" offset="0">Return</paper-tooltip>
          </div>
          <div hidden$="[[!heading]]" id="revealHeading" class="title-text">[[heading]]</div>
        </div>
        <div class="tile-content" id="revealContent"></div>
      </reveal-content>
    </neon-animated-pages-autosize>

  </template>
</dom-module>
<script>
  (function() {
    'use strict';

    new Polymer({
      is: 'kpi-tile',
      behaviors: [
        Polymer.KpiTileBehavior,
        Polymer.IronResizableBehavior
      ],
      listeners: {
        'iron-resize': '_onIronResize'
      },
      ready:function(){
        var _this = this;
        this._computeHeadingClass();
        this.async(this._computeInfo);
      },

      _onIronResize:function(e){
        this.debounce('recomputeHeight', function(){
          this.classList.remove('valign');
          this.$.revealPage.classList.remove('layout','vertical','flex');
          this.$.revealPage.style.minHeight='';
          var oldHeight = this.$.revealPage.style.height;
          this.style.minHeight='';
          this._computeHeight(oldHeight);
        }, 300);
      },
      _displayInfo : function(event) {
        this.$.revealPage.style.height = this.$.revealPage.clientHeight + 'px';
        this.$.tile.sharedElements = {
          'ripple': event.target,
          'reverse-ripple': event.target
        };
        this.$.revealPage.selected = 1;
      },
      _hideInfo : function() {
        this.$.revealPage.selected = 0;
        this.$.revealPage.style.height='';
      },
      _computeHeight:function(oldHeight){
        if(oldHeight){console.log(oldHeight);}
        var height=window.getComputedStyle(this).getPropertyValue('height');
        if(height!=='auto' && height!=='100%'){
          this.style.minHeight=height;
          this.$.revealPage.style.minHeight=height;
        }
        this.classList.add('valign');
        this.$.revealPage.classList.add('layout','vertical','flex');

      },
      _computeHeadingClass: function() {
        var cls = ['title-text'];
        //remove extra paddings on title and justify if both icons
        if (this.icon && (this.info || Polymer.dom(this).querySelector('#info'))){cls.push('center-justified'); cls.push('pl0');cls.push('pr0');}
        else if (this.icon) {cls.push('pl0');}
        else if (this.info || Polymer.dom(this).querySelector('#info')) {cls.push('pr0');}
        if(this.image){
          this.$$('.header-wrapper').classList.add('image');
          this.$$('.image').style.backgroundImage='url('+this.image+')';
        }
        if(this.$.tileHeading && this.$.tileHeading.classList && !this.$.tileHeading.classList.contains('title-text')){
          for(var i=0;i<cls.length;i++){this.$.tileHeading.classList.add(cls[i]);}
        }
        if(this.$.revealHeading && this.$.revealHeading.classList && !this.$.revealHeading.classList.contains('title-text')){
          Polymer.dom(this.$.revealHeading).setAttribute('class', cls.join(' '));
        }

      },
      _computeInfo: function() {
        if(!this.info){
          var supposedInfo = Polymer.dom(this).querySelector('#info');
          if(supposedInfo){
            this.info = supposedInfo.innerHTML;
            Polymer.dom(this).removeChild(supposedInfo);
          }
        }
        if(this.info && this.info.length>0){ // passed as attribute
          this.$.revealContent.innerHTML = this.info;
          this.classList.add('hasInfo');
        }
      }

    });
  })();
</script>


