<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="..\..\bower_components/paper-menu/paper-menu.html">
<link rel="import" href="..\..\bower_components/paper-menu/paper-submenu.html">
<link rel="import" href="..\..\bower_components/paper-item/paper-item.html">
<link rel="import" href="..\..\bower_components/iron-icons/iron-icons.html">
<link rel="import" href="..\..\bower_components/iron-icon/iron-icon.html">
<dom-module id="reportal-menu">
  <template>
    <style>
      :host {
        display: block;
      }
      .content-wrapper > ::content .yui3-menu-content{display:none !important}

      paper-menu {

      }
      .content-wrapper > ::content paper-item>iron-icon[icon="expand-more"]{
        margin-right:0 !important;
      @apply(--reportal-menu-expand-icon);
      }
      .content-wrapper > ::content .paper-submenu>paper-item {
      @apply(--layout-horizontal);
      }
      .content-wrapper > ::content paper-item {
        font-size: 13px;
        font-weight: normal;
        line-height:32px;
        cursor:pointer;
        padding: 0 16px 0 16px;
      @apply(--reportal-menu-item);
      }
      .content-wrapper > ::content .selectable-content.paper-menu > *:focus:after {
        background:transparent;
      @apply(--reportal-menu-item-focused);
      }

      .content-wrapper > ::content .paper-submenu>paper-item>paper-item-body {
      @apply(--layout-flex);
      }
      .content-wrapper > ::content paper-submenu paper-submenu paper-menu{
        padding: 0 0 0 16px ;
      @apply(--reportal-menu-nested);
      }
      .content-wrapper > ::content paper-submenu paper-menu{
        padding: 0px;
      }

      .content-wrapper > ::content .menu-container> paper-menu>div>paper-menu,
      .content-wrapper > ::content .menu-container> paper-menu>div>paper-submenu:not(:first-child)>div{
        border-top:1px solid #ccc;
      @apply(--reportal-menu-toplevel-border);
      }
      .content-wrapper > ::content iron-icon.placeholder{display:none}


    </style>
    <div class="content-wrapper"><content></content></div>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'reportal-menu',
        properties: {
          icons:{
            type: Array,
            value: []
          },
          legacyIcons: String, //aid reportal requotation space-delimited by default
          legacyIconsSeparator:String //separator for legacy icons, space by default
        },
        listeners: {
          'iron-select':'goTO'
        },
        created:function(){
          var menu = Polymer.dom(this.root).querySelector('ul');
          var host = document.createElement('div');
          Polymer.dom(host).setAttribute('class','menu-container');
          this._iteration(Polymer.dom(menu).childNodes, host);
          Polymer.dom(this.root).appendChild(host);
        },
        ready:function(){
          var topIcons=this.querySelectorAll('iron-icon.placeholder');
          if(this.icons.length>0){
            for(var i=0;i<topIcons.length;i++){
              if(this.icons[i]){
                topIcons[i].classList.remove('placeholder');
                topIcons[i].setAttribute('icon',this.icons[i]);
              }
            }
          } else if (this.legacyIcons.length>0){ //aid reportal requotation
            var legacyIcons = this.legacyIcons.split(this.legacyIconsSeparator ? this.legacyIconsSeparator : ' ');
            for(var li=0;li<topIcons.length;li++){
              if(legacyIcons[li]){
                topIcons[li].classList.remove('placeholder');
                topIcons[li].setAttribute('icon',legacyIcons[li]);
              }
            }
          }
        },
        _iteration:function(items, obj, attr){
          var menuNode,submenuNode,menuitemNode,label,submenu,localChildnodes,menuitemBody,curItem,itemIcon;
          menuNode = document.createElement('paper-menu');
          if(attr){
            for(var a=0;a<attr.length;a++){
              Polymer.dom(menuNode).setAttribute(attr[a][0], attr[a][1]);
            }
          }
          for (var i=0;i<items.length;i++){
            curItem = items[i];
            if(curItem.tagName == "LI"){
              localChildnodes = curItem.childNodes;
              label = this._contains(localChildnodes,'tagName', 'A');
              submenu = this._contains(localChildnodes,'tagName', 'DIV');
              if(submenu[0]){ // if has inner div it has children
                submenuNode = document.createElement('paper-submenu');
                menuitemNode = document.createElement('paper-item');
                Polymer.dom(menuitemNode).classList.add('menu-trigger');
                // read selected class from menu and set expanded and selected state on new menu.
                if(this._hasClass(curItem.classList, 'css-menu-child-selected')){
                  Polymer.dom(submenuNode).setAttribute('opened','');
                  Polymer.dom(submenuNode).classList.add('iron-selected');
                  Polymer.dom(menuitemNode).classList.add('iron-selected');
                }
                menuitemBody = document.createElement('paper-item-body');
                Polymer.dom(menuitemBody).textContent = Polymer.dom(localChildnodes[label[1]]).textContent;
                var menuitemArrow = document.createElement('iron-icon');
                Polymer.dom(menuitemArrow).setAttribute('icon','expand-more');
                if(this._hasClass(curItem.classList, 'css-menu-topitem')){
                  console.log('creating');
                  itemIcon = document.createElement('iron-icon');
                  Polymer.dom(itemIcon).setAttribute('class','placeholder');
                  Polymer.dom(menuitemNode).appendChild(itemIcon);
                }
                Polymer.dom(menuitemNode).appendChild(menuitemBody);
                Polymer.dom(menuitemNode).appendChild(menuitemArrow);
                Polymer.dom(submenuNode).appendChild(menuitemNode);
                this._iteration(localChildnodes[submenu[1]].querySelector('ul').childNodes, submenuNode, [["class","menu-content"]] ); //next level iteration
                Polymer.dom(menuNode).appendChild(submenuNode);
              } else { // it's a single item
                menuitemNode = document.createElement('paper-item');
                if(this._hasClass(curItem.classList, 'css-menu-selected')){
                  Polymer.dom(menuitemNode).classList.add('iron-selected');
                }
                if(this._hasClass(curItem.classList, 'css-menu-topitem')){
                  console.log('creating');
                  itemIcon = document.createElement('iron-icon');
                  Polymer.dom(itemIcon).setAttribute('class','placeholder');
                  Polymer.dom(menuitemNode).appendChild(itemIcon);
                }
                menuitemBody = document.createElement('paper-item-body');
                Polymer.dom(menuitemBody).textContent = Polymer.dom(localChildnodes[label[1]]).textContent;
                Polymer.dom(menuitemNode).setAttribute('action',Polymer.dom(localChildnodes[label[1]]).node.href.split(':').reverse()[0])
                Polymer.dom(menuitemNode).appendChild(menuitemBody);
                Polymer.dom(menuNode).appendChild(menuitemNode);
              }
            }
          }
          Polymer.dom(obj).appendChild(menuNode);
        },
        goTO:function(e){
          var allIrons = this.querySelectorAll('paper-item.iron-selected:not(.menu-trigger)[role="listitem"]');
          if(allIrons.length>1){
            for(var i=0;i<allIrons.length;i++){
              if(allIrons[i] != e.target.selectedItem) allIrons[i].classList.remove('iron-selected');
            }
          }
          eval(e.target.selectedItem.getAttribute('action'));
        },
        _contains:function(a, prop, obj){
          var i = a.length;
          while (i--) {
            if (a[i][prop] === obj) {
              return [true, i];
            }
          }
          return [false];
        },
        _hasClass: function (a, obj) {
          var i = a.length;
          while (i--) {
            if (a[i] === obj) {
              return true;
            }
          }
          return false;
        }
      });
    })();
  </script>
</dom-module>
